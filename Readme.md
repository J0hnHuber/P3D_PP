# 📄 P3D Postprozessor System – Erweiterte Dokumentation

## 📚 Inhalt

- [Einleitung](#einleitung)
- [IP3DPostProcessor Funktionen erklärt](#ip3dpostprocessor-funktionen-erklärt)
  - [Initialize](#initialize)
  - [Fedrat](#fedrat)
  - [Goto](#goto)
  - [Rapid](#rapid)
  - [PPrint](#pprint)
  - [MultAx](#multax)
  - [Done](#done)
- [Dynamische Formulare mit FormInput](#dynamische-formulare-mit-forminput)
- [Beispielhafte Nutzung](#beispielhafte-nutzung)
- [Erweiterungsideen](#erweiterungsideen)

---

## Einleitung

Dieses Postprozessor-System basiert auf dem `IP3DPostProcessor` Interface und wird von P3D automatisch aufgerufen, wenn eine APT-Datei verarbeitet wird. Jede APT-Anweisung (`FEDRAT`, `GOTO`, `PPRINT`, usw.) löst einen Methodenaufruf aus. Innerhalb dieser Methoden erzeugt der Entwickler gezielt G-Code-Zeilen mit Hilfe des Register-Systems.

---

## IP3DPostProcessor Funktionen erklärt

### 🟩 `Initialize(CLData data)`

**Wann:**  
Wird **einmalig am Anfang** der Verarbeitung aufgerufen.

**Was sie macht:**  
- Zeigt ein Eingabedialog mit Feldern wie Text, Checkbox, Integer, Float, ComboBox.
- Initialisiert Register mit z.B. `X`, `Y`, `Z`, `F`, `G`.
- Setzt die automatische Nummerierung für G-Code-Zeilen.
- Gibt Header-Kommentare im G-Code aus (Datum, Copyright).

**Wichtig:**  
Register müssen hier mindestens einmal registriert werden, damit sie später verwendet werden können.

**Beispiel:**
```csharp
RegisterAdd("X", "X", decimalPlaces: 4, trailingZeros: 5);
RegisterAdd("F", "F");
```

**Headerausgabe:**
```text
; Code generated by P3D ...
```

---

### 🟩 `Fedrat(CLData data)`

**Wann:**  
Immer, wenn der Befehl `FEDRAT / <WERT>` im APT erscheint.

**Was sie macht:**  
- Setzt den Registerwert für Vorschub `F` (Feedrate).
- Merkt sich, dass die Bewegung **nicht** mehr "rapid" ist (`_isRapid = false`).

**Achtung:**  
Die Feedrate wird nicht direkt ausgegeben – sie wird beim nächsten `GOTO` mit ausgegeben.

**Beispiel APT:**
```text
FEDRAT / 500
```

**Intern:**
```csharp
RegisterSetValue("F", data["F"]);
```

---

### 🟩 `Goto(CLData data)`

**Wann:**  
Bei jeder `GOTO / X,Y,Z` Anweisung in der APT-Datei.

**Was sie macht:**  
- Setzt Positionsdaten in den Registern `X`, `Y`, `Z`.
- Prüft mit `ShouldOutblock()`, ob sich etwas geändert hat.
- Gibt einen G-Code Outblock aus.
- Fügt G0 (schnell) oder G1 (normal) in Register `G` je nach `_isRapid`.

**APT Beispiel:**
```text
GOTO / 12.5, 25.7, -1.0
```

**Erzeugter G-Code:**
```text
N10 G1 X12.5000 Y25.7000 Z-1.0000 F500
```

---

### 🟩 `Rapid(CLData data)`

**Wann:**  
Bei Auftreten von `RAPID` im APT-Code.

**Was sie macht:**  
- Setzt den Flag `_isRapid = true`.
- Damit werden folgende Bewegungen als `G0` statt `G1` interpretiert.

**APT Beispiel:**
```text
RAPID
```

**Folgende GOTO wird dann:**
```text
N20 G0 X30.0000 Y50.0000 Z10.0000
```

---

### 🟩 `PPrint(CLData data)`

**Wann:**  
Immer wenn `PPRINT / 'text'` in der APT steht.

**Was sie macht:**  
- Gibt den übergebenen Kommentar in den G-Code als `; Kommentar` aus.

**APT Beispiel:**
```text
PPRINT / 'Start position'
```

**G-Code:**
```text
; Start position
```

---

### 🟩 `MultAx(CLData data)`

**Wann:**  
Bei `MULTAX / ON` oder `MULTAX / OFF`.

**Was sie macht:**  
- Setzt den Flag `_multAx` auf `true` oder `false`.

**Hinweis:**  
Dieser Wert kann später genutzt werden, um mehrachsige Maschinen speziell zu behandeln.

---

### 🟩 `Done()`

**Wann:**  
Ganz am Ende der APT-Verarbeitung.

**Was sie macht:**  
- Holt den gesamten G-Code mit `RegisterGetCode()`.
- Gibt dir die Möglichkeit, den G-Code nachträglich zu modifizieren.
- Du kannst z. B. letzte Kommentare hinzufügen oder leere Zeilen entfernen.

**Tipp:**  
Bearbeite `gcodeLines[]` hier mit Schleifen, Regex etc.

---

## Dynamische Formulare mit `FormInput`

### Verwendung in `Initialize()`

```csharp
var parameters = new List<InputFormParameter>
{
    new InputFormParameter { Name = "Speed", Type = InputType.Float, Value = 100.0f },
    new InputFormParameter { Name = "Enable Coolant", Type = InputType.Checkbox, Value = true },
    new InputFormParameter { Name = "Mode", Type = InputType.ComboBox, Value = "Normal", DataSource = new[] { "Fast", "Normal", "Slow" } }
};

if (FormInput.TryGetValues("Machine Setup", parameters, out var result))
{
    var speed = (float)result["Speed"];
    var coolant = (bool)result["Enable Coolant"];
}
```

**Mögliche Typen:**
- `InputType.Text`
- `InputType.Checkbox`
- `InputType.Integer`
- `InputType.Float`
- `InputType.ComboBox`

---

## Beispielhafte Nutzung

### Beispiel APT-Datei
```text
PPRINT / 'Begin program'
FEDRAT / 600
GOTO / 0,0,0
RAPID
GOTO / 100,50,0
```

### Möglicher G-Code Output
```text
; Begin program
N10 G1 X0.0000 Y0.0000 Z0.0000 F600
N20 G0 X100.0000 Y50.0000 Z0.0000
```

---

## Erweiterungsideen

- 🔧 Support für weitere APT-Kommandos wie `CIRCLE`, `SPINDL`, `TOOLNO`.
- 🛠️ Validierungslogik für Pflichtfelder im UI-Dialog.
- 💾 Preset-System für gespeicherte Benutzerparameter.
- 🧪 Automatische Tests für die generierte G-Code-Ausgabe.
- 🖥️ Erweiterte G-Code Templates mit Vorlagen pro Maschine.

---

## Lizenz

© Datentechnik Reitz GmbH & Co. KG  
Nur zur internen Verwendung in Verbindung mit P3D.

